<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scryfall Data Visualization Sandbox</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- D3.js for data visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-100 */
        }

        /* Custom scrollbar for a better dark mode aesthetic */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }

        /* D3 Tooltip Styling */
        .d3-tooltip {
            position: absolute;
            text-align: center;
            padding: 8px 12px;
            font-size: 0.875rem;
            background: #1f2937; /* bg-gray-800 */
            color: #f9fafb; /* text-gray-50 */
            border: 1px solid #4b5563; /* border-gray-600 */
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Chart container styling for responsive grid */
        .chart-wrapper {
            overflow: hidden; /* Important for the side panel */
        }
        
        .chart-side-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        .chart-side-panel.is-open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">

            <!-- Header -->
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-white">Scryfall Data Visualization Sandbox</h1>
                <p class="mt-2 text-lg text-gray-400">Build custom charts from any Scryfall query.</p>
            </header>

            <!-- Search Section -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg sticky top-4 z-20">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="search-query" placeholder="Enter Scryfall query (e.g., t:dragon year>=2020)" class="flex-grow bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition duration-200">
                    <button id="search-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-3 rounded-lg transition duration-200 shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500 flex items-center justify-center">
                        <svg id="search-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        <svg id="search-spinner" class="animate-spin h-5 w-5 mr-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Search
                    </button>
                </div>
                <!-- Progress Bar -->
                <div id="progress-container" class="mt-4 hidden">
                    <div id="progress-text" class="text-sm text-gray-300 mb-1 text-center">Loading...</div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                 <!-- Search Error Message -->
                <div id="search-error" class="mt-4 text-center text-red-400 hidden"></div>
            </div>

            <!-- Chart Builder UI -->
            <div id="chart-builder" class="bg-gray-800 p-6 rounded-xl shadow-lg mt-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-white">Chart Builder</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Chart Type -->
                    <div>
                        <label for="chart-type" class="block text-sm font-medium text-gray-300 mb-1">Chart Type</label>
                        <select id="chart-type" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                            <option value="bar">Bar Chart</option>
                            <option value="pie">Donut Chart</option>
                        </select>
                    </div>
                    <!-- Data Property -->
                    <div>
                        <label for="data-property" class="block text-sm font-medium text-gray-300 mb-1">Data Property</label>
                        <select id="data-property" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                            <option>-- Search first --</option>
                        </select>
                    </div>
                    <!-- Array Handling Wrapper -->
                    <div id="array-handling-wrapper" class="hidden">
                        <label for="array-handling-mode" class="block text-sm font-medium text-gray-300 mb-1">Array Handling</label>
                        <select id="array-handling-mode" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                            <option value="flatten">Flatten (Count Each)</option>
                            <option value="combine">Combine (Exact Match)</option>
                            <option value="summarize" id="summarize-option" class="hidden">Summarize (Colors Only)</option>
                        </select>
                    </div>
                    <!-- Category Limit Wrapper -->
                    <div id="category-limit-wrapper" class="hidden">
                        <label for="category-limit" class="block text-sm font-medium text-gray-300 mb-1">Category Limit</label>
                        <input type="number" id="category-limit" value="15" min="1" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    </div>
                    <!-- Chart Title -->
                    <div class="col-span-1 md:col-span-2 lg:col-span-4">
                        <label for="chart-title" class="block text-sm font-medium text-gray-300 mb-1">Chart Title (Optional)</label>
                        <input type="text" id="chart-title" placeholder="e.g., 'Card Distribution by Rarity'" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button id="add-chart-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition duration-200 shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-green-500">
                        Add Chart
                    </button>
                </div>
            </div>

            <!-- Dashboard for Charts -->
            <main id="chart-grid" class="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-6 mt-8"></main>
        </div>
    </div>
    
    <!-- D3 Tooltip Element -->
    <div id="d3-tooltip" class="d3-tooltip"></div>

    <!-- Modal for Card Image Drill-down -->
    <div id="card-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-xl w-full max-w-5xl h-[90vh] flex flex-col shadow-2xl">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 id="modal-title" class="text-xl font-semibold text-white">Cards</h3>
                <button id="modal-close" class="text-gray-400 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="modal-content" class="p-4 flex-grow overflow-y-auto">
                <div id="modal-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <!-- Card images will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification/Alert Area -->
    <div id="notification-area" class="fixed top-5 right-5 z-[100] flex flex-col items-end gap-2">
        <!-- Notifications will be appended here -->
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM ELEMENT REFERENCES ---
    const searchButton = document.getElementById('search-button');
    const searchInput = document.getElementById('search-query');
    const searchIcon = document.getElementById('search-icon');
    const searchSpinner = document.getElementById('search-spinner');
    const searchError = document.getElementById('search-error');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const chartBuilder = document.getElementById('chart-builder');
    const dataPropertySelect = document.getElementById('data-property');
    const addChartButton = document.getElementById('add-chart-button');
    const chartGrid = document.getElementById('chart-grid');
    const chartTypeSelect = document.getElementById('chart-type');
    const categoryLimitWrapper = document.getElementById('category-limit-wrapper');
    const categoryLimitInput = document.getElementById('category-limit');
    const arrayHandlingWrapper = document.getElementById('array-handling-wrapper');
    const arrayHandlingModeSelect = document.getElementById('array-handling-mode');
    const summarizeOption = document.getElementById('summarize-option');
    const chartTitleInput = document.getElementById('chart-title');
    const tooltip = d3.select("#d3-tooltip");
    const cardModal = document.getElementById('card-modal');
    const modalCloseButton = document.getElementById('modal-close');
    const modalContent = document.getElementById('modal-content');
    const modalTitle = document.getElementById('modal-title');
    const modalGrid = document.getElementById('modal-grid');


    // --- APPLICATION STATE ---
    let allCards = [];
    const chartDataCache = {}; 

    // --- CORE FUNCTIONS ---
    function showAlert(message, isError = false) {
        const notificationArea = document.getElementById('notification-area');
        const alertId = `alert-${Date.now()}`;
        const bgColor = isError ? 'bg-red-500' : 'bg-indigo-600';

        const alertDiv = document.createElement('div');
        alertDiv.id = alertId;
        alertDiv.className = `max-w-sm rounded-lg shadow-lg text-white text-sm py-2.5 px-4 ${bgColor} transform transition-all duration-300 translate-x-full opacity-0`;
        alertDiv.textContent = message;

        notificationArea.appendChild(alertDiv);
        requestAnimationFrame(() => {
            alertDiv.classList.remove('translate-x-full', 'opacity-0');
        });
        setTimeout(() => {
            alertDiv.classList.add('opacity-0');
            alertDiv.addEventListener('transitionend', () => alertDiv.remove());
        }, 4000);
    }

    async function fetchScryfallData(query) {
        searchError.classList.add('hidden');
        searchError.textContent = '';
        progressContainer.classList.remove('hidden');
        progressText.textContent = 'Initiating search...';
        progressBar.style.width = '0%';
        searchButton.disabled = true;
        searchIcon.classList.add('hidden');
        searchSpinner.classList.remove('hidden');

        let cards = [];
        let next_page_url = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}`;
        let total_cards = 0;

        try {
            while (next_page_url) {
                const response = await fetch(next_page_url);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || `HTTP error! status: ${response.status}`);
                }
                const pageData = await response.json();
                if (!total_cards) total_cards = pageData.total_cards;
                
                cards.push(...pageData.data);
                
                const progressPercentage = Math.round((cards.length / total_cards) * 100);
                progressBar.style.width = `${progressPercentage}%`;
                progressText.textContent = `Loading... ${cards.length} / ${total_cards} cards`;
                
                next_page_url = pageData.has_more ? pageData.next_page : null;
                if (next_page_url) await new Promise(resolve => setTimeout(resolve, 100)); 
            }
            allCards = cards;
            clearUnpinnedCharts();
            populateDataPropertyDropdown();
            chartBuilder.classList.remove('hidden');
            progressText.textContent = `Success! Found ${total_cards} cards.`;
        } catch (error) {
            console.error('Scryfall API Error:', error);
            allCards = [];
            chartBuilder.classList.add('hidden');
            searchError.textContent = `Search failed: ${error.message}`;
            searchError.classList.remove('hidden');
            progressContainer.classList.add('hidden');
        } finally {
            searchButton.disabled = false;
            searchIcon.classList.remove('hidden');
            searchSpinner.classList.add('hidden');
        }
    }

    function populateDataPropertyDropdown() {
        if (allCards.length === 0) return;
        const firstCard = allCards[0];
        const validKeys = Object.keys(firstCard).filter(key => {
            const value = firstCard[key];
            return typeof value !== 'object' || Array.isArray(value) || value === null;
        }).sort();

        dataPropertySelect.innerHTML = '<option value="">-- Select a property --</option>';
        validKeys.forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = key;
            dataPropertySelect.appendChild(option);
        });
        updateDynamicUI(); // Reset UI state
    }

    function clearUnpinnedCharts() {
        const charts = chartGrid.querySelectorAll('.chart-wrapper');
        charts.forEach(chart => {
            if (!chart.dataset.pinned || chart.dataset.pinned === 'false') {
                const chartId = chart.dataset.chartId;
                if (chartId) delete chartDataCache[chartId];
                chart.remove();
            }
        });
    }

    function processData(property, chartId, hiddenCategories = new Set()) {
        const dataSource = chartDataCache[chartId];
        if (!dataSource) return [];

        const counts = new Map();
        const firstValue = dataSource.find(c => c[property] != null)?.[property];
        const isArray = Array.isArray(firstValue);
        
        const chartWrapper = document.querySelector(`[data-chart-id="${chartId}"]`);
        const config = chartWrapper ? JSON.parse(chartWrapper.dataset.config) : {};
        const arrayMode = config.arrayMode || arrayHandlingModeSelect.value;
        const isColorProp = property === 'colors' || property === 'color_identity';

        if (isArray) {
            switch (arrayMode) {
                case 'summarize':
                    dataSource.forEach(card => {
                        const value = card[property] || [];
                        let category = value.length === 0 ? 'Colorless' : value.length > 1 ? 'Multicolor' : value[0];
                        counts.set(category, (counts.get(category) || 0) + 1);
                    });
                    break;
                case 'combine':
                    dataSource.forEach(card => {
                        const value = card[property] || [];
                        let category = value.length === 0 ? (isColorProp ? 'Colorless' : 'None') : [...value].sort().join('');
                        counts.set(category, (counts.get(category) || 0) + 1);
                    });
                    break;
                case 'flatten':
                default:
                    dataSource.forEach(card => {
                        const value = card[property] || [];
                        if (value.length === 0) {
                            const emptyCategory = isColorProp ? 'Colorless' : 'None';
                            counts.set(emptyCategory, (counts.get(emptyCategory) || 0) + 1);
                        } else {
                            value.forEach(item => counts.set(item, (counts.get(item) || 0) + 1));
                        }
                    });
                    break;
            }
        } else {
            dataSource.forEach(card => {
                let value = card[property];
                if (value == null) value = 'N/A';
                counts.set(value, (counts.get(value) || 0) + 1);
            });
        }
        
        let data = Array.from(counts, ([label, value]) => ({ label, value }))
                      .filter(d => !hiddenCategories.has(String(d.label)));
        
        const isNumeric = typeof firstValue === 'number' && !isArray;
        if (isNumeric) {
            data.sort((a, b) => a.label - b.label);
        } else {
            data.sort((a, b) => b.value - a.value);
            const limit = parseInt(config.limit, 10) || 15;
            data = data.slice(0, limit);
        }
        
        return data;
    }
    
    function updateDynamicUI() {
        const property = dataPropertySelect.value;
        if (!property) {
            categoryLimitWrapper.classList.add('hidden');
            arrayHandlingWrapper.classList.add('hidden');
            return;
        }

        const firstValue = allCards.find(c => c[property] != null)?.[property];
        const isNumeric = typeof firstValue === 'number' && !Array.isArray(firstValue);
        const isArray = Array.isArray(firstValue);

        categoryLimitWrapper.classList.toggle('hidden', isNumeric);
        arrayHandlingWrapper.classList.toggle('hidden', !isArray);

        if (isArray) {
            const isColorProp = property === 'colors' || property === 'color_identity';
            summarizeOption.classList.toggle('hidden', !isColorProp);
            if (!isColorProp && arrayHandlingModeSelect.value === 'summarize') {
                arrayHandlingModeSelect.value = 'flatten';
            }
        }
    }
    
    function getInitialColor(label, property) {
        const magicColorMap = {
            'W': '#f8f8f8', 'U': '#5e9fe6', 'B': '#3c3c3c',
            'R': '#e47878', 'G': '#5b9971', 'Multicolor': '#d4af37', 'Colorless': '#a9a9a9',
            'None': '#6b7280',
            'WU': '#a5b4fc', 'UB': '#7c3aed', 'BR': '#ef4444', 'RG': '#22c55e', 'GW': '#facc15',
            'WB': '#a8a29e', 'UR': '#f97316', 'BG': '#15803d', 'RW': '#fed7aa', 'GU': '#2dd4bf'
        };
        if (magicColorMap[label]) return magicColorMap[label];

        const defaultPalette = [
            '#55a8e2', '#69d2e7', '#a7dbd8', '#e0e4cc', '#f38630',
            '#fa6900', '#fe4365', '#fc9d9a', '#f9cdad', '#c8c8a9',
            '#83af9b', '#ecd078', '#d95b43', '#c02942', '#542437',
            '#53777a', '#a3a948', '#edb92e', '#f2583e', '#d84a38'
        ];
        let hash = 0;
        for (let i = 0; i < String(label).length; i++) {
            hash = String(label).charCodeAt(i) + ((hash << 5) - hash);
        }
        return defaultPalette[Math.abs(hash) % defaultPalette.length];
    }

    function createChart() {
        const property = dataPropertySelect.value;
        if (!property) {
            showAlert('Please select a data property to visualize.', true);
            return;
        }

        const chartId = `chart_${crypto.randomUUID()}`;
        chartDataCache[chartId] = [...allCards];

        const chartWrapper = document.createElement('div');
        chartWrapper.className = 'chart-wrapper h-96 bg-gray-800 rounded-xl shadow-lg p-4 flex flex-col relative';
        chartWrapper.dataset.pinned = 'false';
        chartWrapper.dataset.chartId = chartId;
        
        const firstValue = allCards.find(c => c[property] != null)?.[property];
        const isArray = Array.isArray(firstValue);
        const config = {
            property, chartType: chartTypeSelect.value, 
            title: chartTitleInput.value || `${property.replace(/_/g, ' ')} Distribution`, 
            limit: categoryLimitInput.value,
            arrayMode: isArray ? arrayHandlingModeSelect.value : null
        };
        chartWrapper.dataset.config = JSON.stringify(config);
        
        const data = processData(property, chartId);
        if (data.length === 0) {
            showAlert(`No data found for property: ${property}.`, true);
            delete chartDataCache[chartId];
            return;
        }

        buildChartControls(chartWrapper, data);

        const chartElement = document.createElement('div');
        chartElement.className = 'flex-grow min-h-0';
        chartWrapper.appendChild(chartElement);
        
        chartGrid.prepend(chartWrapper);
        
        requestAnimationFrame(() => redrawChart(chartId));
    }
    
    function buildChartControls(chartWrapper, initialData) {
        const chartId = chartWrapper.dataset.chartId;

        const mainControls = document.createElement('div');
        mainControls.className = 'absolute top-3 right-3 z-20 flex gap-2';
        // FIX: Updated settings icon to a 'sliders' icon
        mainControls.innerHTML = `
            <button class="settings-btn p-2 bg-gray-700 hover:bg-gray-600 rounded-full transition text-gray-300 hover:text-white" title="Customize Categories">
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                </svg>
            </button>
            <button class="delete-btn p-2 bg-gray-700 hover:bg-red-500 rounded-full transition text-gray-300 hover:text-white" title="Delete chart">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
            </button>
        `;

        const pinControl = document.createElement('div');
        pinControl.className = 'absolute top-3 left-3 z-20';
        pinControl.innerHTML = `<button class="pin-btn p-2 bg-gray-700 hover:bg-gray-600 rounded-full transition text-gray-300 hover:text-white" title="Pin chart"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg></button>`;
        
        const sidePanel = document.createElement('div');
        sidePanel.className = 'chart-side-panel absolute top-0 right-0 h-full w-64 bg-gray-900 bg-opacity-90 backdrop-blur-sm p-4 z-10 shadow-lg';
        sidePanel.innerHTML = `<h4 class="text-lg font-bold mb-3 text-white">Category Customization</h4>`;
        
        const controlList = document.createElement('div');
        controlList.className = 'flex flex-col gap-2 overflow-y-auto h-[calc(100%-2rem)]';

        initialData.forEach(({ label }) => {
            const item = document.createElement('div');
            item.className = 'flex items-center gap-2 text-sm';
            item.innerHTML = `
                <input type="checkbox" id="vis-${chartId}-${label}" data-label="${label}" class="visibility-toggle h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500 cursor-pointer" checked>
                <input type="color" id="color-${chartId}-${label}" data-label="${label}" class="chart-color-input h-6 w-8 p-0 border-none rounded cursor-pointer bg-transparent" value="${getInitialColor(label, '')}">
                <label for="vis-${chartId}-${label}" class="text-gray-300 truncate flex-1" title="${label}">${label}</label>
            `;
            controlList.appendChild(item);
        });

        sidePanel.appendChild(controlList);
        chartWrapper.append(pinControl, mainControls, sidePanel);
    }

    function redrawChart(chartId) {
        const chartWrapper = document.querySelector(`[data-chart-id="${chartId}"]`);
        if (!chartWrapper) return;
        
        const config = JSON.parse(chartWrapper.dataset.config);
        const chartElement = chartWrapper.querySelector('.flex-grow');
        
        const hiddenCategories = new Set();
        chartWrapper.querySelectorAll('.visibility-toggle:not(:checked)').forEach(toggle => {
            hiddenCategories.add(toggle.dataset.label);
        });

        const customColorMap = new Map();
        chartWrapper.querySelectorAll('.chart-color-input').forEach(input => {
            customColorMap.set(input.dataset.label, input.value);
        });

        const colorScale = d3.scaleOrdinal()
            .domain(Array.from(customColorMap.keys()))
            .range(Array.from(customColorMap.values()));
            
        const data = processData(config.property, chartId, hiddenCategories);

        if (config.chartType === 'bar') {
            renderBarChart(chartElement, data, config.title, colorScale, chartId);
        } else {
            renderPieChart(chartElement, data, config.title, colorScale, chartId);
        }
    }

    function renderBarChart(container, data, title, colorScale, chartId) {
        const margin = {top: 40, right: 30, bottom: 100, left: 60};
        const { width, height } = container.getBoundingClientRect();
        if (width <= 0 || height <= 0) return;

        d3.select(container).select('svg').remove();
        const svg = d3.select(container).append("svg").attr("width", width).attr("height", height)
            .append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        
        const w = width - margin.left - margin.right;
        const h = height - margin.top - margin.bottom;
        const x = d3.scaleBand().range([0, w]).domain(data.map(d => d.label)).padding(0.2);
        svg.append("g").attr("transform", `translate(0,${h})`).call(d3.axisBottom(x))
            .selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end").style("fill", "#9ca3af");
        
        const y = d3.scaleLinear().domain([0, d3.max(data, d => d.value) || 1]).range([h, 0]);
        svg.append("g").call(d3.axisLeft(y)).selectAll("text").style("fill", "#9ca3af");
        
        svg.selectAll("mybar").data(data, d => d.label).join(
            enter => enter.append("rect")
                .attr("x", d => x(d.label))
                .attr("y", y(0))
                .attr("width", x.bandwidth())
                .attr("height", 0)
                .attr("fill", d => colorScale(d.label))
                .style("cursor", "pointer")
                .on("click", (event, d) => showCardModal(d.label, chartId))
                .on("mouseover", () => tooltip.style("opacity", 1))
                .on("mousemove", (event, d) => {
                    const total = d3.sum(data, item => item.value);
                    const percentage = total > 0 ? ((d.value / total) * 100).toFixed(1) : 0;
                    tooltip.html(`<strong>${d.label}</strong><br>${d.value} cards (${percentage}%)`)
                        .style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0))
                .transition().duration(500)
                .attr("y", d => y(d.value))
                .attr("height", d => h - y(d.value)),
            update => update
                .transition().duration(500)
                .attr("x", d => x(d.label))
                .attr("y", d => y(d.value))
                .attr("width", x.bandwidth())
                .attr("height", d => h - y(d.value))
                .attr("fill", d => colorScale(d.label)),
            exit => exit.transition().duration(500)
                .attr("y", y(0))
                .attr("height", 0)
                .remove()
        );

        svg.selectAll('.chart-title').data([title]).join('text')
            .attr("class", 'chart-title')
            .attr("x", w / 2).attr("y", 0 - (margin.top / 2)).attr("text-anchor", "middle")
            .style("font-size", "16px").style("fill", "white").style("font-weight", "bold").text(t => t);
    }
    
    function renderPieChart(container, data, title, colorScale, chartId) {
        const margin = { top: 40, right: 20, bottom: 20, left: 20 };
        const { width, height } = container.getBoundingClientRect();
        if (width <= 0 || height <= 0) return;

        d3.select(container).select('svg').remove();
        const radius = Math.min(width, height) / 2 - Math.max(margin.top, margin.right);
        const svg = d3.select(container).append("svg").attr("width", width).attr("height", height)
            .append("g").attr("transform", `translate(${width / 2}, ${height / 2})`);
        
        const pie = d3.pie().value(d => d.value).sort(null);
        const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.8);
        
        svg.selectAll('path').data(pie(data), d => d.data.label).join(
            enter => enter.append('path')
                .attr('fill', d => colorScale(d.data.label))
                .attr('stroke', '#1f2937').style('stroke-width', '2px').style("cursor", "pointer")
                .on("click", (event, d) => showCardModal(d.data.label, chartId))
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1);
                    d3.select(event.currentTarget).transition().duration(200).attr('d', d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.85));
                })
                .on("mousemove", (event, d) => {
                    const total = d3.sum(data, item => item.value);
                    const percentage = total > 0 ? ((d.data.value / total) * 100).toFixed(1) : 0;
                    tooltip.html(`<strong>${d.data.label}</strong><br>${d.data.value} cards (${percentage}%)`)
                        .style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", (event, d) => {
                    tooltip.style("opacity", 0);
                    d3.select(event.currentTarget).transition().duration(200).attr('d', arc);
                })
                .transition().duration(800)
                .attrTween('d', d => {
                    const i = d3.interpolate({ startAngle: d.startAngle, endAngle: d.startAngle }, d);
                    return t => arc(i(t));
                }),
            update => update,
            exit => exit.transition().duration(800).attrTween('d', d => {
                    const i = d3.interpolate(d, { startAngle: d.endAngle, endAngle: d.endAngle });
                    return t => arc(i(t));
                }).remove()
        );
        
        svg.selectAll('.chart-title').data([title]).join('text')
            .attr("class", 'chart-title')
            .attr("x", 0).attr("y", -height/2 + margin.top -5).attr("text-anchor", "middle")
            .style("font-size", "16px").style("fill", "white").style("font-weight", "bold").text(t => t);
    }
    
    function showCardModal(categoryLabel, chartId) {
        modalGrid.innerHTML = ''; 
        const dataSource = chartDataCache[chartId] || [];
        const chartWrapper = document.querySelector(`[data-chart-id="${chartId}"]`);
        if (!chartWrapper) return;
        
        const config = JSON.parse(chartWrapper.dataset.config);
        const { property, arrayMode } = config;

        const filteredCards = dataSource.filter(card => {
            const val = card[property] || [];
            if (arrayMode) {
                let cardCategory;
                const isColorProp = property === 'colors' || property === 'color_identity';
                switch(arrayMode) {
                    case 'summarize':
                        cardCategory = val.length === 0 ? 'Colorless' : val.length > 1 ? 'Multicolor' : val[0];
                        return cardCategory === categoryLabel;
                    case 'combine':
                        cardCategory = val.length === 0 ? (isColorProp ? 'Colorless' : 'None') : [...val].sort().join('');
                        return cardCategory === categoryLabel;
                    case 'flatten':
                    default:
                        if (val.length === 0) return categoryLabel === (isColorProp ? 'Colorless' : 'None');
                        return val.includes(categoryLabel);
                }
            }
            const cardCategory = (card[property] == null) ? 'N/A' : String(card[property]);
            return cardCategory === categoryLabel;
        });

        modalTitle.textContent = `${categoryLabel} (${filteredCards.length} cards)`;

        if(filteredCards.length > 0) {
            filteredCards.forEach(card => {
                const imgUrl = card.image_uris?.normal || card.card_faces?.[0]?.image_uris?.normal;
                if (imgUrl && card.scryfall_uri) {
                    const link = document.createElement('a');
                    link.href = card.scryfall_uri;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    img.alt = card.name;
                    img.className = 'w-full rounded-lg shadow-md hover:scale-105 transition-transform duration-200';
                    img.loading = 'lazy';
                    link.appendChild(img);
                    modalGrid.appendChild(link);
                }
            });
        } else {
            modalGrid.innerHTML = `<p class="text-gray-400 col-span-full text-center">No cards with images found for this category.</p>`;
        }
        cardModal.classList.remove('hidden');
    }

    // --- EVENT LISTENERS ---
    searchButton.addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (query) fetchScryfallData(query);
        else showAlert('Please enter a search query.', true);
    });
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchButton.click();
    });
    addChartButton.addEventListener('click', createChart);
    dataPropertySelect.addEventListener('change', updateDynamicUI);
    modalCloseButton.addEventListener('click', () => cardModal.classList.add('hidden'));
    cardModal.addEventListener('click', (e) => {
        if (e.target === cardModal) cardModal.classList.add('hidden');
    });

    chartGrid.addEventListener('click', (e) => {
        const chartWrapper = e.target.closest('.chart-wrapper');
        if (!chartWrapper) return;
        const chartId = chartWrapper.dataset.chartId;

        if (e.target.closest('.delete-btn')) {
            if (chartId) delete chartDataCache[chartId];
            chartWrapper.remove();
        } else if (e.target.closest('.pin-btn')) {
            const pinBtn = e.target.closest('.pin-btn');
            const isPinned = chartWrapper.dataset.pinned === 'true';
            chartWrapper.dataset.pinned = !isPinned;
            pinBtn.classList.toggle('bg-indigo-500', !isPinned);
            pinBtn.classList.toggle('bg-gray-700', isPinned);
            pinBtn.classList.toggle('text-white', !isPinned);
            pinBtn.title = isPinned ? 'Pin chart' : 'Unpin chart';
        } else if (e.target.closest('.settings-btn')) {
            chartWrapper.querySelector('.chart-side-panel').classList.toggle('is-open');
        }
    });

    chartGrid.addEventListener('change', (e) => {
        const chartWrapper = e.target.closest('.chart-wrapper');
        if (chartWrapper && (e.target.matches('.visibility-toggle') || e.target.matches('.chart-color-input'))) {
            redrawChart(chartWrapper.dataset.chartId);
        }
    });
});
</script>

</body>
</html>
